<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار الشخصية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #adb5bd;
            --white-color: #ffffff;
            --whatsapp-color: #25D366;
            --whatsapp-dark: #128C7E;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            margin: 0;
            padding: 20px;
            color: var(--dark-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            margin: 20px auto;
            background: var(--white-color);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 700;
            position: relative;
            padding-bottom: 15px;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 50%;
            transform: translateX(50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(to right, var(--primary-color), var(--success-color));
            border-radius: 2px;
        }
        
        h2 {
            color: var(--secondary-color);
            text-align: center;
            margin-bottom: 25px;
            font-size: 26px;
            font-weight: 600;
        }
        
        h3 {
            color: var(--dark-color);
            margin-bottom: 20px;
            font-size: 22px;
            font-weight: 500;
            line-height: 1.4;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.6s ease;
        }
        
        .active {
            display: block;
        }
        
        input, select {
            width: 100%;
            padding: 16px 20px;
            margin: 12px 0;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 17px;
            transition: all 0.3s;
            background-color: var(--light-color);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15);
            background-color: var(--white-color);
        }
        
        button {
            width: 100%;
            padding: 16px;
            margin: 15px 0;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--white-color);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.4);
        }
        
        .btn-whatsapp {
            background: linear-gradient(135deg, var(--whatsapp-color), var(--whatsapp-dark));
            color: var(--white-color);
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }
        
        .btn-whatsapp:hover {
            background: linear-gradient(135deg, var(--whatsapp-dark), var(--whatsapp-color));
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(37, 211, 102, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c1121f);
            color: var(--white-color);
            box-shadow: 0 4px 15px rgba(247, 37, 133, 0.3);
        }
        
        .btn-secondary {
            background: var(--light-color);
            color: var(--dark-color);
            border: 1px solid var(--gray-color);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #f3722c);
            color: var(--white-color);
            box-shadow: 0 4px 15px rgba(248, 150, 30, 0.3);
        }
        
        button:disabled {
            background: var(--gray-color);
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .hearts {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
        }
        
        .heart {
            width: 40px;
            height: 40px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transition: all 0.3s;
            filter: drop-shadow(0 2px 5px rgba(247, 37, 133, 0.3));
        }
        
        .heart.inactive {
            opacity: 0.3;
            transform: scale(0.85);
            filter: none;
        }
        
        .timer {
            background: linear-gradient(135deg, var(--dark-color), #343a40);
            color: var(--white-color);
            padding: 14px;
            border-radius: 10px;
            text-align: center;
            margin: 25px 0;
            font-size: 20px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .question-container {
            margin: 30px 0;
            padding: 25px;
            background: var(--white-color);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        
        .options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 25px;
        }
        
        .option {
            background: var(--white-color);
            text-align: right;
            cursor: pointer;
            border: 2px solid #e9ecef;
            font-size: 17px;
            padding: 18px 20px;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .option:hover {
            border-color: var(--primary-color);
            transform: translateX(-5px);
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .option.correct {
            background-color: rgba(76, 201, 240, 0.1);
            border-color: var(--success-color);
            color: #1a936f;
        }
        
        .option.incorrect {
            background-color: rgba(247, 37, 133, 0.1);
            border-color: var(--danger-color);
            color: #c1121f;
        }
        
        .option.selected {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .progress-container {
            margin: 30px 0;
            background: var(--light-color);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.05);
            height: 14px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .results-container {
            text-align: center;
        }
        
        .score-circle {
            width: 150px;
            height: 150px;
            margin: 0 auto 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: conic-gradient(
                var(--success-color) 0% calc(var(--score-percentage) * 1%),
                var(--light-color) calc(var(--score-percentage) * 1%) 100%
            );
            box-shadow: 0 10px 30px rgba(76, 201, 240, 0.3);
            position: relative;
        }
        
        .score-circle::before {
            content: '';
            position: absolute;
            width: 130px;
            height: 130px;
            background: var(--white-color);
            border-radius: 50%;
        }
        
        .score-value {
            font-size: 42px;
            font-weight: 700;
            color: var(--primary-color);
            position: relative;
            z-index: 1;
            line-height: 1;
        }
        
        .score-total {
            font-size: 18px;
            color: var(--gray-color);
            position: relative;
            z-index: 1;
        }
        
        .result-details {
            margin-top: 30px;
            text-align: right;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .detail-value {
            color: var(--secondary-color);
            font-weight: 500;
        }
        
        .error {
            color: var(--danger-color);
            font-size: 15px;
            margin: -8px 0 15px 10px;
            display: none;
            font-weight: 500;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            font-size: 20px;
            display: none;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--whatsapp-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        /* أنماط الحماية */
        .prevent-capture {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            text-align: center;
            padding: 20px;
        }
        
        .exit-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 9998;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            text-align: center;
            padding: 20px;
        }
        
        .exit-warning button {
            width: auto;
            margin: 20px;
            padding: 10px 20px;
        }
        
        /* أنماط منع النسخ */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .no-copy-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
            animation: fadeInOut 2s ease;
        }
        
        /* أنماط الصوت */
        .sound-control {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* أنماط الإشعارات */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 26px;
            }
            
            h2 {
                font-size: 22px;
            }
            
            h3 {
                font-size: 20px;
            }
            
            input, button, .option {
                padding: 14px;
                font-size: 16px;
            }
            
            .question-container {
                padding: 20px;
            }
            
            .score-circle {
                width: 120px;
                height: 120px;
            }
            
            .score-circle::before {
                width: 100px;
                height: 100px;
            }
            
            .score-value {
                font-size: 32px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
                border-radius: 12px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            h2 {
                font-size: 20px;
            }
            
            h3 {
                font-size: 18px;
            }
            
            .exit-warning {
                font-size: 18px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- عنصر التحكم بالصوت -->
    <div class="sound-control" id="sound-control">
        <i class="fas fa-volume-up" id="sound-icon"></i>
    </div>
    
    <!-- إشعارات -->
    <div class="notification" id="notification"></div>
    
    <!-- رسالة منع النسخ -->
    <div class="no-copy-message" id="no-copy-message">
        <i class="fas fa-ban"></i> النسخ غير مسموح به في هذا الاختبار
    </div>

    <div class="container">
        <h1>اختبار الشخصية</h1>
        
        <!-- شاشة البداية -->
        <div class="section active" id="welcome-screen">
            <h2>مرحباً بك في اختبار الشخصية</h2>
            <p style="text-align: center; margin-bottom: 30px; font-size: 18px; color: var(--dark-color);">
                هذا الاختبار سيحدد شخصيتك بناءً على إجاباتك. الرجاء الإجابة بصدق للحصول على نتائج دقيقة.
            </p>
            <button id="start-btn" class="btn-primary">
                <i class="fas fa-play"></i> بدء الاختبار
            </button>
        </div>
        
        <!-- شاشة البيانات الشخصية -->
        <div class="section" id="user-info">
            <h2>البيانات الشخصية</h2>
            <div>
                <input type="text" id="user-name" placeholder="الاسم الكامل" required>
                <p class="error" id="name-error">الاسم يجب أن يكون 3 أحرف على الأقل</p>
            </div>
            <div>
                <input type="number" id="user-age" placeholder="العمر" min="10" max="100" required>
                <p class="error" id="age-error">العمر يجب أن يكون بين 10 و 100</p>
            </div>
            <div>
                <input type="email" id="user-email" placeholder="البريد الإلكتروني" required>
                <p class="error" id="email-error">بريد إلكتروني غير صالح</p>
            </div>
            <div>
                <input type="tel" id="user-phone" placeholder="رقم الهاتف" required>
                <p class="error" id="phone-error">رقم هاتف غير صالح</p>
            </div>
            <button id="start-test" class="btn-primary" disabled>
                <i class="fas fa-play"></i> بدء الاختبار
            </button>
            <p class="error" id="duplicate-error">هذه البيانات مستخدمة من قبل</p>
        </div>
        
        <!-- شاشة الاختبار -->
        <div class="section" id="quiz-container">
            <div class="hearts" id="hearts-container">
                <!-- سيتم إضافة القلوب ديناميكيًا -->
            </div>
            
            <div class="timer">
                الوقت المتبقي: <span id="time">10:00</span>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            
            <div class="question-container">
                <h3><span class="question-number" id="question-num">1</span> <span id="question-text">سؤال الاختبار هنا...</span></h3>
                <div class="options" id="options-container">
                    <!-- سيتم إضافة الخيارات ديناميكيًا -->
                </div>
            </div>
            
            <button id="skip-question" class="btn-warning" style="margin-top: 10px;">
                <i class="fas fa-forward"></i> تخطي السؤال (سيخصم محاولة واحدة)
            </button>
        </div>
        
        <!-- شاشة النتائج -->
        <div class="section" id="results">
            <div class="results-container">
                <h2>نتيجة الاختبار</h2>
                
                <div class="score-circle" id="score-circle">
                    <span class="score-value" id="score-value">0</span>
                    <span class="score-total" id="score-total">/0</span>
                </div>
                
                <div class="result-details">
                    <div class="detail-row">
                        <span class="detail-label">الاسم:</span>
                        <span class="detail-value" id="result-name"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">الدرجة:</span>
                        <span class="detail-value" id="result-score"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">الوقت المستغرق:</span>
                        <span class="detail-value" id="time-taken"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">التاريخ:</span>
                        <span class="detail-value" id="result-date"></span>
                    </div>
                </div>
                
                <div id="personality-result" style="margin-top: 30px; text-align: right;">
                    <h3 style="color: var(--primary-color);">التقدير:</h3>
                    <p id="personality-description" style="line-height: 1.6;"></p>
                </div>
                
                <button id="send-results" class="btn-whatsapp send-results-btn" style="margin-top: 30px;">
                    <i class="fab fa-whatsapp"></i> مشاركة عبر واتساب
                </button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loading-text">جاري إعداد الاختبار...</p>
    </div>
    
    <div class="prevent-capture" id="prevent-capture">
        <div>
            <i class="fas fa-ban" style="font-size: 50px; color: red; margin-bottom: 20px;"></i>
            <p>غير مسموح بالتقاط صور للاختبار أثناء المحاولة</p>
            <p>سيتم تسجيل أي محاولة غش!</p>
        </div>
    </div>
    
    <div class="exit-warning" id="exit-warning">
        <div>
            <i class="fas fa-exclamation-triangle" style="font-size: 50px; color: orange; margin-bottom: 20px;"></i>
            <p>تحذير: إذا خرجت من الاختبار الآن سيتم احتسابها محاولة فاشلة!</p>
            <p>هل تريد حقاً الخروج؟</p>
            <div>
                <button id="cancel-exit" class="btn-primary">
                    <i class="fas fa-arrow-left"></i> العودة للاختبار
                </button>
                <button id="confirm-exit" class="btn-danger">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
        </div>
    </div>

    <!-- عناصر الصوت -->
    <audio id="correct-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
    <audio id="wrong-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>
    <audio id="timer-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-fast-clock-ticking-1064.mp3" loop></audio>
    <audio id="bg-music" src="https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3" loop></audio>

    <script>
        // المتغيرات العامة
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxyRgTcfif_gt0--OMpHw9rRPZZtTdZy7xyjNK52jdkeLKi4EnLSShrLHp__th9LyE1/exec";
        const usersKey = 'quizParticipants';
        let users = JSON.parse(localStorage.getItem(usersKey)) || [];
        let maxHearts = 3;
        let hearts = maxHearts;
        let timeLeft = 300;
        let timer;
        let currentQuestion = 0;
        let score = 0;
        let userData = {};
        let startTime;
        let selectedOption = null;
        let isTestActive = false;
        let testAttempted = false;
        let soundEnabled = true;
        const targetPhoneNumber = "1234567890";

        // إعدادات القلوب
        const heartImages = {
            active: "https://cdn.pixabay.com/photo/2017/09/23/16/33/pixel-heart-2779422_640.png",
            inactive: "https://cdn.pixabay.com/photo/2017/09/23/16/33/pixel-heart-2779422_640.png"
        };

        // الأسئلة
        const questions = [
            {
                text: "ما هو الشيء الذي تفضله في وقت الفراغ؟",
                options: [
                    { text: "قراءة الكتب", correct: false, personality: "مفكر" },
                    { text: "ممارسة الرياضة", correct: true, personality: "نشيط" },
                    { text: "مشاهدة الأفلام", correct: false, personality: "مبدع" },
                    { text: "التسوق", correct: false, personality: "اجتماعي" }
                ]
            },
            {
                text: "كيف تتعامل مع الضغوط؟",
                options: [
                    { text: "أخذ استراحة", correct: true, personality: "هادئ" },
                    { text: "الاستمرار في العمل", correct: false, personality: "مجتهد" },
                    { text: "التحدث مع الأصدقاء", correct: false, personality: "اجتماعي" },
                    { text: "الغضب", correct: false, personality: "عصبي" }
                ]
            },
            {
                text: "ما هو أهم شيء في الحياة بالنسبة لك؟",
                options: [
                    { text: "الصحة", correct: true, personality: "عملي" },
                    { text: "المال", correct: false, personality: "طموح" },
                    { text: "الأسرة", correct: false, personality: "عائلي" },
                    { text: "النجاح", correct: false, personality: "قائد" }
                ]
            }
        ];

        // عناصر DOM
        const sections = document.querySelectorAll('.section');
        const startBtn = document.getElementById('start-test');
        const startScreenBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('user-name');
        const ageInput = document.getElementById('user-age');
        const emailInput = document.getElementById('user-email');
        const phoneInput = document.getElementById('user-phone');
        const errorElements = document.querySelectorAll('.error');
        const duplicateError = document.getElementById('duplicate-error');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const sendResultsBtn = document.getElementById('send-results');
        const skipQuestionBtn = document.getElementById('skip-question');
        const preventCapture = document.getElementById('prevent-capture');
        const exitWarning = document.getElementById('exit-warning');
        const cancelExitBtn = document.getElementById('cancel-exit');
        const confirmExitBtn = document.getElementById('confirm-exit');
        const heartsContainer = document.getElementById('hearts-container');
        const noCopyMessage = document.getElementById('no-copy-message');
        const soundControl = document.getElementById('sound-control');
        const soundIcon = document.getElementById('sound-icon');
        const notification = document.getElementById('notification');
        const personalityResult = document.getElementById('personality-result');
        const personalityDesc = document.getElementById('personality-description');

        // عناصر الصوت
        const correctSound = document.getElementById('correct-sound');
        const wrongSound = document.getElementById('wrong-sound');
        const timerSound = document.getElementById('timer-sound');
        const bgMusic = document.getElementById('bg-music');

        // الأحداث
        startScreenBtn.addEventListener('click', startTestProcess);
        startBtn.addEventListener('click', startTest);
        sendResultsBtn.addEventListener('click', sendResultsWithScreenshot);
        skipQuestionBtn.addEventListener('click', skipQuestion);
        cancelExitBtn.addEventListener('click', () => exitWarning.style.display = 'none');
        confirmExitBtn.addEventListener('click', confirmExit);
        soundControl.addEventListener('click', toggleSound);

        // التحقق من صحة البيانات
        nameInput.addEventListener('input', validateForm);
        ageInput.addEventListener('input', validateForm);
        emailInput.addEventListener('input', validateForm);
        phoneInput.addEventListener('input', validateForm);

        // بدء عملية الاختبار
        function startTestProcess() {
            showSection('user-info');
            playSound('bg-music');
        }

        // التحكم بالصوت
        function toggleSound() {
            soundEnabled = !soundEnabled;
            soundIcon.className = soundEnabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
            
            if (soundEnabled) {
                bgMusic.play().catch(e => console.log('لا يمكن تشغيل الصوت:', e));
            } else {
                bgMusic.pause();
                timerSound.pause();
            }
            
            showNotification(soundEnabled ? 'تم تفعيل الصوت' : 'تم إيقاف الصوت');
        }

        // تشغيل صوت معين
        function playSound(soundId) {
            if (!soundEnabled) return;
            
            const sound = document.getElementById(soundId);
            sound.currentTime = 0;
            sound.play().catch(e => console.log('لا يمكن تشغيل الصوت:', e));
        }

        // عرض إشعار
        function showNotification(message) {
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // إنشاء القلوب
        function createHearts() {
            heartsContainer.innerHTML = '';
            for (let i = 0; i < maxHearts; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.id = `heart${i+1}`;
                heart.style.backgroundImage = `url(${heartImages.active})`;
                heartsContainer.appendChild(heart);
            }
        }

        // تحقق من صحة النموذج
        function validateForm() {
            let isValid = true;
            resetErrors();

            if (nameInput.value.trim().length < 3) {
                showError('name-error', 'الاسم يجب أن يكون 3 أحرف على الأقل');
                isValid = false;
            }

            const age = parseInt(ageInput.value);
            if (isNaN(age) || age < 10 || age > 100) {
                showError('age-error', 'العمر يجب أن يكون بين 10 و 100');
                isValid = false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailInput.value)) {
                showError('email-error', 'بريد إلكتروني غير صالح');
                isValid = false;
            }

            const phoneRegex = /^[0-9]{10,15}$/;
            if (!phoneRegex.test(phoneInput.value)) {
                showError('phone-error', 'رقم هاتف غير صالح');
                isValid = false;
            }

            if (isDuplicateUser()) {
                showError('duplicate-error', 'هذه البيانات مستخدمة من قبل');
                isValid = false;
            }

            startBtn.disabled = !isValid;
            return isValid;
        }

        function isDuplicateUser() {
            const name = nameInput.value.trim().toLowerCase();
            const email = emailInput.value.trim().toLowerCase();
            const phone = phoneInput.value.trim();

            return users.some(user => 
                user.name.toLowerCase() === name || 
                user.email.toLowerCase() === email || 
                user.phone === phone
            );
        }

        function showError(id, message) {
            const errorElement = document.getElementById(id);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function resetErrors() {
            errorElements.forEach(el => {
                el.style.display = 'none';
            });
        }

        // منع النسخ واللصق
        function preventCopying() {
            document.addEventListener('selectstart', function(e) {
                if (isTestActive) {
                    e.preventDefault();
                    showNoCopyMessage();
                }
            });
            
            document.addEventListener('contextmenu', function(e) {
                if (isTestActive) {
                    e.preventDefault();
                    showNoCopyMessage();
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (isTestActive && (e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C' || e.key === 'x' || e.key === 'X')) {
                    e.preventDefault();
                    showNoCopyMessage();
                }
            });
            
            if (isTestActive) {
                document.getElementById('question-text').classList.add('no-select');
                document.getElementById('options-container').classList.add('no-select');
            }
        }
        
        function showNoCopyMessage() {
            noCopyMessage.style.display = 'block';
            
            setTimeout(() => {
                noCopyMessage.style.display = 'none';
            }, 2000);
        }

        // بدء الاختبار
        function startTest() {
            if (!validateForm()) return;

            isTestActive = true;
            testAttempted = false;
            
            createHearts();
            preventScreenCapture();
            preventExit();
            preventCopying();

            userData = {
                name: nameInput.value.trim(),
                age: ageInput.value.trim(),
                email: emailInput.value.trim(),
                phone: phoneInput.value.trim(),
                timestamp: new Date().toISOString(),
                testType: 'personality'
            };

            users.push(userData);
            localStorage.setItem(usersKey, JSON.stringify(users));

            showLoading('جاري تحميل الاختبار...');
            
            setTimeout(() => {
                hideLoading();
                showSection('quiz-container');
                startTime = new Date();
                startTimer();
                loadQuestion();
            }, 1500);
        }

        // عرض شاشة التحميل
        function showLoading(message) {
            loadingText.textContent = message;
            loadingOverlay.style.display = 'flex';
        }

        // إخفاء شاشة التحميل
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function showSection(sectionId) {
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === sectionId) {
                    section.classList.add('active');
                }
            });
        }

        // بدء المؤقت
        function startTimer() {
            updateTimerDisplay();
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 30 && timeLeft > 0) {
                    playSound('timer-sound');
                }
                
                if (timeLeft <= 0) endTest();
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('time').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            if (timeLeft <= 30) {
                document.getElementById('time').style.color = 'var(--danger-color)';
            }
        }

        // تحميل السؤال
        function loadQuestion() {
            if (currentQuestion >= questions.length) {
                endTest();
                return;
            }
            
            const question = questions[currentQuestion];
            const questionTextElement = document.getElementById('question-text');
            questionTextElement.textContent = question.text;
            questionTextElement.classList.add('no-select');
            
            document.getElementById('question-num').textContent = currentQuestion + 1;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.add('no-select');
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option no-select';
                button.textContent = option.text;
                button.onclick = () => selectOption(button, option.correct, option.personality);
                optionsContainer.appendChild(button);
            });
            
            const progress = (currentQuestion / questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            
            // تحديث حالة زر التخطي بناءً على عدد المحاولات المتبقية
            skipQuestionBtn.disabled = hearts < 2;
            
            selectedOption = null;
        }

        // اختيار الإجابة
        function selectOption(optionElement, isCorrect, personalityType) {
            if (selectedOption !== null) return;
            
            selectedOption = { 
                element: optionElement, 
                correct: isCorrect,
                personality: personalityType
            };
            optionElement.classList.add('selected');
            
            setTimeout(() => {
                checkAnswer(isCorrect, personalityType);
            }, 800);
        }

        // تخطي السؤال
        function skipQuestion() {
            // التحقق من وجود محاولات كافية للتخطي
            if (hearts < 1) {
                showNotification('لا يوجد محاولات كافية لتخطي السؤال');
                return;
            }
            
            // خصم محاولة واحدة
            hearts--;
            document.getElementById(`heart${hearts + 1}`).classList.add('inactive');
            document.getElementById(`heart${hearts + 1}`).style.backgroundImage = `url(${heartImages.inactive})`;
            
            showNotification('تم تخطي السؤال وخصم محاولة واحدة');
            
            // الانتقال إلى السؤال التالي
            currentQuestion++;
            loadQuestion();
            
            // تعطيل الزر إذا لم يعد هناك محاولات كافية
            skipQuestionBtn.disabled = hearts < 2;
            
            // إنهاء الاختبار إذا نفذت المحاولات
            if (hearts <= 0) {
                setTimeout(() => endTest(), 1500);
            }
        }

        // التحقق من الإجابة
        function checkAnswer(isCorrect, personalityType) {
            const options = document.querySelectorAll('.option');
            
            options.forEach(option => {
                if (option === selectedOption.element) {
                    option.classList.add(isCorrect ? 'correct' : 'incorrect');
                    
                    if (isCorrect) {
                        playSound('correct-sound');
                    } else {
                        playSound('wrong-sound');
                    }
                } else {
                    const correctOption = Array.from(options).find(opt => 
                        opt.textContent === questions[currentQuestion].options.find(opt => opt.correct).text
                    );
                    if (!isCorrect) {
                        correctOption.classList.add('correct');
                    }
                }
                
                option.style.pointerEvents = 'none';
            });
            
            if (isCorrect) {
                score++;
                
                if (personalityType) {
                    userData.personality = userData.personality || {};
                    userData.personality[personalityType] = (userData.personality[personalityType] || 0) + 1;
                }
            } else {
                hearts--;
                document.getElementById(`heart${hearts + 1}`).classList.add('inactive');
                document.getElementById(`heart${hearts + 1}`).style.backgroundImage = `url(${heartImages.inactive})`;
                
                if (hearts <= 0) {
                    setTimeout(() => endTest(), 1500);
                    return;
                }
            }
            
            setTimeout(() => {
                currentQuestion++;
                loadQuestion();
            }, 1500);
        }

        // إنهاء الاختبار
        function endTest() {
            isTestActive = false;
            clearInterval(timer);
            timerSound.pause();
            
            const endTime = new Date();
            const timeTaken = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(timeTaken / 60);
            const seconds = timeTaken % 60;
            const timeString = `${minutes} دقائق و ${seconds} ثواني`;
            const currentDate = new Date().toLocaleDateString('ar-EG');
            
            document.getElementById('result-name').textContent = userData.name;
            document.getElementById('result-score').textContent = `${score}/${questions.length}`;
            document.getElementById('time-taken').textContent = timeString;
            document.getElementById('result-date').textContent = currentDate;
            
            const percentage = Math.round((score / questions.length) * 100);
            document.getElementById('score-circle').style.setProperty('--score-percentage', percentage);
            animateScore(0, score, 1000);
            document.getElementById('score-total').textContent = `/${questions.length}`;
            
            // عرض التقدير
            personalityResult.style.display = 'block';
            personalityDesc.textContent = getGradeDescription(percentage);
            
            showSection('results');
            saveResults(percentage, timeString, currentDate);
        }

        // الحصول على وصف التقدير
        function getGradeDescription(percentage) {
            if (percentage >= 90) {
                return "ممتاز! لديك شخصية متوازنة ومتكاملة.";
            } else if (percentage >= 70) {
                return "جيد جداً! لديك شخصية قوية مع بعض الجوانب التي يمكن تطويرها.";
            } else if (percentage >= 50) {
                return "جيد! لديك شخصية متوسطة مع بعض الجوانب التي تحتاج إلى تحسين.";
            } else {
                return "ضعيف! تحتاج إلى العمل على تطوير شخصيتك وتحسين مهاراتك الاجتماعية.";
            }
        }

        // عرض النتيجة متحركة
        function animateScore(start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(progress * (end - start) + start);
                document.getElementById('score-value').textContent = value;
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // حفظ النتائج
        async function saveResults(percentage, timeTaken, date) {
            const resultData = {
                type: 'user_data',
                name: userData.name,
                age: userData.age,
                email: userData.email,
                phone: userData.phone,
                score: score,
                totalQuestions: questions.length,
                percentage: percentage,
                timeTaken: timeTaken,
                date: date,
                timestamp: new Date().toISOString(),
                status: testAttempted ? 'فاشلة' : 'ناجحة',
                heartsLeft: hearts,
                testType: 'personality',
                personality: userData.personality
            };

            try {
                loadingText.textContent = 'جاري حفظ النتائج...';
                loadingOverlay.style.display = 'flex';
                
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(resultData)
                });
                
                const result = await response.json();
                console.log("تم إرسال البيانات بنجاح:", result);
                
            } catch (error) {
                console.error("خطأ في إرسال البيانات:", error);
                localStorage.setItem('quiz_backup_' + Date.now(), JSON.stringify(resultData));
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        // إرسال النتائج مع صورة
        async function sendResultsWithScreenshot() {
            loadingText.textContent = 'جاري إعداد النتيجة للإرسال...';
            loadingOverlay.style.display = 'flex';
            
            try {
                const canvas = await html2canvas(document.getElementById('results'));
                const imageData = canvas.toDataURL('image/png');
                
                const message = `نتيجة اختبار الشخصية%0A%0A` +
                                `الاسم: ${userData.name}%0A` +
                                `الدرجة: ${score}/${questions.length}%0A` +
                                `الوقت المستغرق: ${document.getElementById('time-taken').textContent}%0A` +
                                `التاريخ: ${document.getElementById('result-date').textContent}`;
                
                const whatsappUrl = `https://wa.me/${targetPhoneNumber}?text=${message}`;
                
                window.open(whatsappUrl, '_blank');
                
            } catch (error) {
                console.error('Error capturing screenshot:', error);
                alert('حدث خطأ أثناء محاولة إرسال النتيجة. يرجى المحاولة مرة أخرى.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        // تأكيد الخروج
        function confirmExit() {
            testAttempted = true;
            exitWarning.style.display = 'none';
            endTest();
        }
        
        // منع التقاط الشاشة
        function preventScreenCapture() {
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey && e.key === 'PrintScreen') || e.key === 'PrintScreen') {
                    e.preventDefault();
                    showCaptureWarning();
                }
            });
            
            document.addEventListener('contextmenu', (e) => {
                if (isTestActive) {
                    e.preventDefault();
                    showCaptureWarning();
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (isTestActive && (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i'))) {
                    e.preventDefault();
                    showCaptureWarning();
                }
            });
            
            const originalHTML2Canvas = window.html2canvas;
            window.html2canvas = function(...args) {
                if (isTestActive) {
                    showCaptureWarning();
                    return Promise.reject('التصوير غير مسموح أثناء الاختبار');
                }
                return originalHTML2Canvas(...args);
            };
        }
        
        function showCaptureWarning() {
            if (!isTestActive) return;
            
            preventCapture.style.display = 'flex';
            
            setTimeout(() => {
                preventCapture.style.display = 'none';
            }, 3000);
            
            if (isTestActive) {
                const cheatAttempt = {
                    type: 'cheat_attempt',
                    user: userData,
                    timestamp: new Date().toISOString(),
                    action: 'screen_capture_attempt'
                };
                
                console.warn('تم اكتشاف محاولة غش:', cheatAttempt);
                localStorage.setItem('cheat_attempt_' + Date.now(), JSON.stringify(cheatAttempt));
            }
        }
        
        // منع الخروج
        function preventExit() {
            window.addEventListener('blur', () => {
                if (isTestActive && !testAttempted) {
                    showExitWarning();
                }
            });
            
            window.addEventListener('beforeunload', (e) => {
                if (isTestActive && !testAttempted) {
                    e.preventDefault();
                    e.returnValue = 'إذا خرجت الآن سيتم احتساب المحاولة كفاشلة!';
                    return e.returnValue;
                }
            });
        }
        
        // تهيئة التطبيق
        function init() {
            users = JSON.parse(localStorage.getItem('quizParticipants')) || [];
            sendBackupData();
            
            // محاولة تشغيل الصوت عند البدء (سيتخطى إذا كان المتصفح يمنع التشغيل التلقائي)
            bgMusic.volume = 0.3;
            bgMusic.play().catch(e => console.log('لا يمكن تشغيل الصوت تلقائياً:', e));
        }

        // إرسال البيانات المحفوظة عند الاتصال
        async function sendBackupData() {
            const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('quiz_backup_'));
            
            if (backupKeys.length > 0 && navigator.onLine) {
                try {
                    for (const key of backupKeys) {
                        const data = JSON.parse(localStorage.getItem(key));
                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        
                        if (response.ok) {
                            localStorage.removeItem(key);
                            console.log(`تم إرسال البيانات المحفوظة بنجاح: ${key}`);
                        }
                    }
                } catch (error) {
                    console.error("خطأ في إرسال البيانات المحفوظة:", error);
                }
            }
        }

        window.onload = init;
    </script>
</body>
</html>